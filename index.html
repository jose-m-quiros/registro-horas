<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Semanal de Horas Avanzado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            padding: 20px;
            color: #f1f5f9;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        h1 {
            text-align: center;
            color: #f1f5f9;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 600;
        }

        /* Panel desplegable styles */
        .collapsible-panel {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-panel.expanded {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .panel-header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .panel-header:hover {
            background: linear-gradient(135deg, #2563eb, #60a5fa);
        }

        .panel-header.expanded {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .panel-toggle {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .panel-header.expanded .panel-toggle {
            transform: rotate(180deg);
        }

        .panel-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .panel-content.expanded {
            max-height: 2000px;
        }

        .panel-inner {
            padding: 25px;
        }

        /* Salary panel specific styles */
        .salary-panel .panel-header {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
        }

        .salary-panel .panel-header:hover {
            background: linear-gradient(135deg, #8b5cf6, #c084fc);
        }

        .salary-panel .panel-header.expanded {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .salary-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .salary-dropdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .salary-dropdown label {
            color: #cbd5e1;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .salary-dropdown select {
            padding: 12px;
            border: 2px solid #475569;
            border-radius: 8px;
            background: #0f172a;
            color: #f1f5f9;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .salary-dropdown select:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        .salary-summary {
            background: #0f172a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #a855f7;
            margin-top: 20px;
        }

        .salary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(168, 85, 247, 0.2);
        }

        .salary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
            color: #34d399;
        }

        .salary-label {
            color: #cbd5e1;
            font-size: 0.95rem;
        }

        .salary-value {
            color: #a855f7;
            font-weight: 600;
        }

        .total-salary {
            color: #34d399 !important;
            font-size: 1.3rem !important;
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.3);
        }

        .week-info {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 1.1rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .week-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .week-selector label {
            color: #f1f5f9;
            margin-right: 10px;
            font-weight: 500;
        }

        .week-selector input {
            padding: 8px 12px;
            border: 2px solid #475569;
            border-radius: 6px;
            background: #0f172a;
            color: #f1f5f9;
            font-size: 1rem;
        }

        .week-selector input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .day-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            overflow: hidden;
            position: relative;
        }

        .day-section.saved {
            border-color: #10b981;
            background: linear-gradient(135deg, #0f1e17 0%, #1e2d23 100%);
        }

        .save-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .day-section.saved .save-indicator {
            opacity: 1;
        }

        .day-header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 12px 20px;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .day-section.saved .day-header {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .day-date {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-content {
            padding: 25px;
        }

        .time-labels {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 120px;
            gap: 20px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(59, 130, 246, 0.2);
        }

        .time-label {
            color: #cbd5e1;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-inputs-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 120px;
            gap: 20px;
            align-items: center;
        }

        .time-inputs-row input {
            padding: 12px;
            border: 2px solid #475569;
            border-radius: 8px;
            background: #0f172a;
            color: #f1f5f9;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .time-inputs-row input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .time-inputs-row input.saved {
            border-color: #10b981;
            background: #0f1e17;
        }

        .total-display {
            background: #0f172a;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #60a5fa;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.3);
            transition: all 0.3s ease;
        }

        .total-display.saved {
            border-color: #10b981;
            color: #34d399;
            background: #0f1e17;
        }

        .save-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #2563eb, #60a5fa);
            transform: translateY(-1px);
        }

        .save-btn.saved {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .summary-label {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .summary-value {
            color: #60a5fa;
            font-size: 1.4rem;
            font-weight: bold;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .copy-btn, .clear-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, #2563eb, #60a5fa);
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.5);
            background: linear-gradient(135deg, #b91c1c, #dc2626);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .status-bar {
            background: #0f172a;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .auto-save-status {
            color: #10b981;
            font-weight: 500;
        }

        .last-saved {
            color: #cbd5e1;
        }

        .reset-notification {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
            animation: slideDown 0.5s ease-out;
            display: none;
        }

        .reset-notification.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .countdown-info {
            background: #0f172a;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(124, 58, 237, 0.3);
            text-align: center;
            font-size: 0.9rem;
            color: #a855f7;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .time-labels,
            .time-inputs-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .time-labels {
                display: none;
            }
            
            .time-inputs-row {
                gap: 15px;
            }
            
            .time-inputs-row input,
            .total-display,
            .save-btn {
                text-align: center;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .salary-controls {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Registro Semanal de Horas Avanzado</h1>
        
        <div class="reset-notification" id="resetNotification">
            üîÑ ¬°Nueva semana iniciada autom√°ticamente! Los datos de la semana anterior se mantienen guardados.
        </div>
        
        <div class="status-bar">
            <div class="auto-save-status" id="autoSaveStatus">
                üü¢ Auto-guardado y reinicio autom√°tico activados
            </div>
            <div class="last-saved" id="lastSaved">
                √öltimo guardado: Nunca
            </div>
        </div>
        
        <div class="countdown-info" id="countdownInfo">
            üïê Pr√≥ximo reinicio autom√°tico: Calculando...
        </div>
        
        <div class="week-selector">
            <label for="weekStart">Semana del:</label>
            <input type="date" id="weekStart">
        </div>
        
        <div class="week-info" id="weekInfo">
            Cargando informaci√≥n de la semana...
        </div>

        <!-- Panel 1: Resumen Semanal -->
        <div class="collapsible-panel" id="summaryPanel">
            <div class="panel-header" onclick="togglePanel('summaryPanel')">
                <span>üìä Resumen Semanal de Horas</span>
                <span class="panel-toggle">‚ñº</span>
            </div>
            <div class="panel-content" id="summaryContent">
                <div class="panel-inner">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total de Horas</div>
                            <div class="summary-value" id="totalHours">0h 0m</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">D√≠as Trabajados</div>
                            <div class="summary-value" id="daysWorked">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Promedio Diario</div>
                            <div class="summary-value" id="averageDaily">0h 0m</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="copy-btn" id="copyBtn">
                            üìã Copiar Registro
                        </button>
                        <button class="clear-btn" id="clearBtn">
                            üóëÔ∏è Limpiar Semana
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel 2: C√°lculo Salarial -->
        <div class="collapsible-panel salary-panel" id="salaryPanel">
            <div class="panel-header" onclick="togglePanel('salaryPanel')">
                <span>üí∞ C√°lculo Salarial en Colones</span>
                <span class="panel-toggle">‚ñº</span>
            </div>
            <div class="panel-content" id="salaryContent">
                <div class="panel-inner">
                    <div class="salary-controls">
                        <div class="salary-dropdown">
                            <label for="jobRole">üëî Puesto de Trabajo:</label>
                            <select id="jobRole" onchange="calculateSalary()">
                                <option value="">Seleccionar puesto...</option>
                                <option value="jefe">üë®‚Äçüíº Jefe - ‚Ç°4,500/hora</option>
                                <option value="peon">üë∑‚Äç‚ôÇÔ∏è Pe√≥n - ‚Ç°2,000/hora</option>
                            </select>
                        </div>
                        <div class="salary-dropdown">
                            <label for="paymentType">üíµ Tipo de Pago:</label>
                            <select id="paymentType" onchange="calculateSalary()">
                                <option value="hourly">Por Horas</option>
                                <option value="daily">Por D√≠a (8h)</option>
                                <option value="weekly">Semanal Completa</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="salary-summary" id="salarySummary" style="display: none;">
                        <div class="salary-row">
                            <span class="salary-label">Horas Trabajadas:</span>
                            <span class="salary-value" id="workedHoursDisplay">0h 0m</span>
                        </div>
                        <div class="salary-row">
                            <span class="salary-label">Tarifa por Hora:</span>
                            <span class="salary-value" id="hourlyRateDisplay">‚Ç°0</span>
                        </div>
                        <div class="salary-row">
                            <span class="salary-label">D√≠as Trabajados:</span>
                            <span class="salary-value" id="daysWorkedDisplay">0</span>
                        </div>
                        <div class="salary-row">
                            <span class="salary-label">Salario Total:</span>
                            <span class="salary-value total-salary" id="totalSalaryDisplay">‚Ç°0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="daysContainer">
            <!-- Los d√≠as se generar√°n aqu√≠ din√°micamente -->
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
        const months = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];

        // Tarifas salariales en colones
        const salaryRates = {
            jefe: 4500,
            peon: 2000
        };

        // Elementos del DOM
        const weekStart = document.getElementById('weekStart');
        const weekInfo = document.getElementById('weekInfo');
        const daysContainer = document.getElementById('daysContainer');
        const totalHours = document.getElementById('totalHours');
        const daysWorked = document.getElementById('daysWorked');
        const averageDaily = document.getElementById('averageDaily');
        const copyBtn = document.getElementById('copyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        const lastSaved = document.getElementById('lastSaved');
        const resetNotification = document.getElementById('resetNotification');
        const countdownInfo = document.getElementById('countdownInfo');

        // Elementos del panel salarial
        const jobRole = document.getElementById('jobRole');
        const paymentType = document.getElementById('paymentType');
        const salarySummary = document.getElementById('salarySummary');
        const workedHoursDisplay = document.getElementById('workedHoursDisplay');
        const hourlyRateDisplay = document.getElementById('hourlyRateDisplay');
        const daysWorkedDisplay = document.getElementById('daysWorkedDisplay');
        const totalSalaryDisplay = document.getElementById('totalSalaryDisplay');

        // Variables globales
        let currentWeekKey = '';
        let autoSaveInterval;
        let weekCheckInterval;
        let countdownInterval;
        let totalWorkedMinutes = 0;
        let totalWorkedDays = 0;

        // Funci√≥n para alternar paneles desplegables
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const header = panel.querySelector('.panel-header');
            const content = panel.querySelector('.panel-content');
            
            const isExpanded = panel.classList.contains('expanded');
            
            if (isExpanded) {
                panel.classList.remove('expanded');
                header.classList.remove('expanded');
                content.classList.remove('expanded');
            } else {
                panel.classList.add('expanded');
                header.classList.add('expanded');
                content.classList.add('expanded');
            }
        }

        // Funci√≥n para calcular salario
        function calculateSalary() {
            const selectedRole = jobRole.value;
            const selectedPaymentType = paymentType.value;
            
            if (!selectedRole) {
                salarySummary.style.display = 'none';
                return;
            }
            
            salarySummary.style.display = 'block';
            
            const hourlyRate = salaryRates[selectedRole];
            const totalHoursDecimal = totalWorkedMinutes / 60;
            
            let totalSalary = 0;
            
            switch (selectedPaymentType) {
                case 'hourly':
                    totalSalary = Math.round(totalHoursDecimal * hourlyRate);
                    break;
                case 'daily':
                    totalSalary = totalWorkedDays * hourlyRate * 8;
                    break;
                case 'weekly':
                    totalSalary = hourlyRate * 40;
                    break;
            }
            
            const hours = Math.floor(totalWorkedMinutes / 60);
            const minutes = totalWorkedMinutes % 60;
            
            workedHoursDisplay.textContent = `${hours}h ${minutes}m`;
            hourlyRateDisplay.textContent = `‚Ç°${hourlyRate.toLocaleString()}`;
            daysWorkedDisplay.textContent = totalWorkedDays;
            totalSalaryDisplay.textContent = `‚Ç°${totalSalary.toLocaleString()}`;
        }

        // Funci√≥n para obtener el pr√≥ximo lunes a las 00:00
        function getNextMondayMidnight() {
            const now = new Date();
            const nextMonday = new Date(now);
            
            let daysUntilMonday;
            if (now.getDay() === 0) {
                daysUntilMonday = 1;
            } else if (now.getDay() === 1) {
                daysUntilMonday = 7;
            } else {
                daysUntilMonday = 8 - now.getDay();
            }
            
            nextMonday.setDate(now.getDate() + daysUntilMonday);
            nextMonday.setHours(0, 0, 0, 0);
            
            return nextMonday;
        }

        // Funci√≥n para actualizar countdown
        function updateCountdown() {
            const now = new Date();
            const nextReset = getNextMondayMidnight();
            const diff = nextReset - now;
            
            if (diff <= 0) {
                countdownInfo.textContent = 'üîÑ Reiniciando semana...';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            let countdownText = 'üïê Pr√≥ximo reinicio autom√°tico: ';
            
            if (days > 0) {
                countdownText += `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                countdownText += `${hours}h ${minutes}m`;
            } else {
                countdownText += `${minutes}m`;
            }
            
            countdownText += ` (lunes 00:00)`;
            countdownInfo.textContent = countdownText;
        }

        // Funci√≥n para verificar si necesita reinicio autom√°tico
        function checkForWeekReset() {
            try {
                const lastWeekCheck = localStorage.getItem('lastWeekCheck');
                const now = new Date();
                const currentMondayKey = generateWeekKey(getMondayOfWeek(now));
                
                if (!lastWeekCheck) {
                    localStorage.setItem('lastWeekCheck', currentMondayKey);
                    return false;
                }
                
                if (lastWeekCheck !== currentMondayKey) {
                    localStorage.setItem('lastWeekCheck', currentMondayKey);
                    return true;
                }
                
                return false;
            } catch(e) {
                console.log('Verificaci√≥n de reinicio en modo demostraci√≥n');
                return false;
            }
        }

        // Funci√≥n para mostrar notificaci√≥n de reinicio
        function showResetNotification() {
            resetNotification.classList.add('show');
            
            setTimeout(() => {
                resetNotification.classList.remove('show');
            }, 5000);
        }

        // Funci√≥n para reiniciar a nueva semana
        function resetToNewWeek() {
            const today = new Date();
            const monday = getMondayOfWeek(today);
            weekStart.value = monday.toISOString().split('T')[0];
            updateWeekInfo();
            showResetNotification();
            
            console.log('Semana reiniciada autom√°ticamente:', formatDate(monday));
        }

        // Funci√≥n para obtener el lunes de la semana
        function getMondayOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Funci√≥n para formatear fecha
        function formatDate(date) {
            try {
                const day = date.getDate();
                const month = months[date.getMonth()];
                return `${day} de ${month}`;
            } catch(e) {
                return 'Fecha inv√°lida';
            }
        }

        // Funci√≥n para generar clave de semana
        function generateWeekKey(mondayDate) {
            return `week_${mondayDate.getFullYear()}_${mondayDate.getMonth()}_${mondayDate.getDate()}`;
        }

        // Funci√≥n para calcular horas entre dos tiempos
        function calculateHoursBetween(start, end, date) {
            if (!start || !end) return { hours: 0, minutes: 0, total: 0 };
            
            const startTime = new Date(`${date}T${start}`);
            let endTime = new Date(`${date}T${end}`);
            
            if (endTime <= startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }
            
            const diffMs = endTime - startTime;
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return { hours, minutes, total: diffMs };
        }

        // Funci√≥n principal de verificaci√≥n de reinicio
        function performWeeklyCheck() {
            const now = new Date();
            
            if (now.getDay() === 1 && now.getHours() === 0 && now.getMinutes() === 0) {
                console.log('üîÑ Iniciando reinicio autom√°tico del lunes...');
                resetToNewWeek();
            }
            
            if (checkForWeekReset()) {
                console.log('üîÑ Detectado cambio de semana, reiniciando...');
                resetToNewWeek();
            }
        }

        // Funci√≥n para guardar datos de un d√≠a espec√≠fico
        function saveDayData(dayIndex) {
            const startInput = document.getElementById(`start-${dayIndex}`);
            const endInput = document.getElementById(`end-${dayIndex}`);
            const saveBtn = document.getElementById(`save-${dayIndex}`);
            const daySection = startInput.closest('.day-section');
            
            try {
                const weekData = JSON.parse(localStorage.getItem(currentWeekKey) || '{}');
                weekData[`day_${dayIndex}`] = {
                    start: startInput.value,
                    end: endInput.value,
                    saved: true,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(currentWeekKey, JSON.stringify(weekData));
            } catch(e) {
                console.log('Datos guardados (simulaci√≥n):', {
                    day: dayIndex,
                    start: startInput.value,
                    end: endInput.value
                });
            }
            
            saveBtn.innerHTML = '‚úÖ Guardado';
            saveBtn.classList.add('saved');
            daySection.classList.add('saved');
            startInput.classList.add('saved');
            endInput.classList.add('saved');
            
            updateLastSaved();
            updateWeeklySummary();
            
            setTimeout(() => {
                saveBtn.innerHTML = 'üíæ Guardar';
                saveBtn.classList.remove('saved');
            }, 2000);
        }

        // Funci√≥n para auto-guardar
        function autoSave() {
            try {
                const weekData = JSON.parse(localStorage.getItem(currentWeekKey) || '{}');
                let hasChanges = false;
                
                for (let i = 0; i < 7; i++) {
                    const startInput = document.getElementById(`start-${i}`);
                    const endInput = document.getElementById(`end-${i}`);
                    
                    if (startInput && endInput) {
                        const currentData = weekData[`day_${i}`] || {};
                        
                        if (currentData.start !== startInput.value || currentData.end !== endInput.value) {
                            weekData[`day_${i}`] = {
                                start: startInput.value,
                                end: endInput.value,
                                saved: false,
                                timestamp: new Date().toISOString()
                            };
                            hasChanges = true;
                        }
                    }
                }
                
                if (hasChanges) {
                    localStorage.setItem(currentWeekKey, JSON.stringify(weekData));
                    updateLastSaved();
                }
            } catch(e) {
                console.log('Auto-guardado simulado');
                updateLastSaved();
            }
        }

        // Funci√≥n para cargar datos guardados
        function loadWeekData() {
            try {
                const weekData = JSON.parse(localStorage.getItem(currentWeekKey) || '{}');
                
                for (let i = 0; i < 7; i++) {
                    const dayData = weekData[`day_${i}`];
                    const startInput = document.getElementById(`start-${i}`);
                    const endInput = document.getElementById(`end-${i}`);
                    
                    if (startInput && endInput) {
                        if (dayData) {
                            startInput.value = dayData.start || '';
                            endInput.value = dayData.end || '';
                            
                            if (dayData.saved) {
                                const daySection = startInput.closest('.day-section');
                                if (daySection) {
                                    daySection.classList.add('saved');
                                    startInput.classList.add('saved');
                                    endInput.classList.add('saved');
                                    const totalEl = document.getElementById(`total-${i}`);
                                    if (totalEl) totalEl.classList.add('saved');
                                }
                            }
                        }
                        
                        updateDayTotal(i);
                    }
                }
            } catch(e) {
                // En Claude.ai no hay datos que cargar
            }
            
            updateWeeklySummary();
            updateLastSaved();
        }

        // Funci√≥n para actualizar √∫ltimo guardado
        function updateLastSaved() {
            const now = new Date();
            lastSaved.textContent = `√öltimo guardado: ${now.toLocaleTimeString('es-ES')}`;
        }

        // Funci√≥n para generar los d√≠as de la semana
        function generateWeek(mondayDate) {
            daysContainer.innerHTML = '';
            currentWeekKey = generateWeekKey(mondayDate);
            
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(mondayDate);
                currentDate.setDate(mondayDate.getDate() + i);
                
                const daySection = document.createElement('div');
                daySection.className = 'day-section';
                daySection.innerHTML = `
                    <div class="save-indicator">üíæ Guardado</div>
                    <div class="day-header">
                        <span>${daysOfWeek[i]}</span>
                        <span class="day-date">${formatDate(currentDate)}</span>
                    </div>
                    <div class="day-content">
                        <div class="time-labels">
                            <div class="time-label">üü¢ Inicio</div>
                            <div class="time-label">üî¥ Fin</div>
                            <div class="time-label">‚è∞ Total</div>
                            <div class="time-label"></div>
                        </div>
                        <div class="time-inputs-row">
                            <input type="time" id="start-${i}" data-day="${i}">
                            <input type="time" id="end-${i}" data-day="${i}">
                            <div class="total-display" id="total-${i}">0h 0m</div>
                            <button class="save-btn" id="save-${i}" onclick="saveDayData(${i})">
                                üíæ Guardar
                            </button>
                        </div>
                    </div>
                `;
                
                daysContainer.appendChild(daySection);
            }
            
            setTimeout(() => {
                for (let i = 0; i < 7; i++) {
                    const startInput = document.getElementById(`start-${i}`);
                    const endInput = document.getElementById(`end-${i}`);
                    
                    if (startInput && endInput) {
                        startInput.addEventListener('change', () => updateDayTotal(i));
                        endInput.addEventListener('change', () => updateDayTotal(i));
                        startInput.addEventListener('input', () => markAsUnsaved(i));
                        endInput.addEventListener('input', () => markAsUnsaved(i));
                    }
                }
                
                loadWeekData();
            }, 50);
        }

        // Funci√≥n para marcar como no guardado
        function markAsUnsaved(dayIndex) {
            const daySection = document.querySelector(`#start-${dayIndex}`).closest('.day-section');
            const startInput = document.getElementById(`start-${dayIndex}`);
            const endInput = document.getElementById(`end-${dayIndex}`);
            const totalDisplay = document.getElementById(`total-${dayIndex}`);
            
            daySection.classList.remove('saved');
            startInput.classList.remove('saved');
            endInput.classList.remove('saved');
            totalDisplay.classList.remove('saved');
        }

        // Funci√≥n para actualizar el total de un d√≠a
        function updateDayTotal(dayIndex) {
            try {
                const monday = getMondayOfWeek(new Date(weekStart.value));
                const currentDate = new Date(monday);
                currentDate.setDate(monday.getDate() + dayIndex);
                
                const startInput = document.getElementById(`start-${dayIndex}`);
                const endInput = document.getElementById(`end-${dayIndex}`);
                const totalDisplay = document.getElementById(`total-${dayIndex}`);
                
                if (!startInput || !endInput || !totalDisplay) {
                    return;
                }
                
                const dateString = currentDate.toISOString().split('T')[0];
                const result = calculateHoursBetween(startInput.value, endInput.value, dateString);
                
                totalDisplay.textContent = `${result.hours}h ${result.minutes}m`;
                
                updateWeeklySummary();
            } catch(e) {
                // Error silencioso
            }
        }

        // Funci√≥n para actualizar el resumen semanal
        function updateWeeklySummary() {
            let totalMs = 0;
            let workingDays = 0;
            
            for (let i = 0; i < 7; i++) {
                const startInput = document.getElementById(`start-${i}`);
                const endInput = document.getElementById(`end-${i}`);
                
                if (startInput && endInput && startInput.value && endInput.value) {
                    const monday = getMondayOfWeek(new Date(weekStart.value));
                    const currentDate = new Date(monday);
                    currentDate.setDate(currentDate.getDate() + i);
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    const result = calculateHoursBetween(startInput.value, endInput.value, dateString);
                    totalMs += result.total;
                    
                    if (result.total > 0) {
                        workingDays++;
                    }
                }
            }
            
            const totalHoursCalc = Math.floor(totalMs / (1000 * 60 * 60));
            const totalMinutesCalc = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));
            
            // Actualizar variables globales para c√°lculo salarial
            totalWorkedMinutes = totalHoursCalc * 60 + totalMinutesCalc;
            totalWorkedDays = workingDays;
            
            totalHours.textContent = `${totalHoursCalc}h ${totalMinutesCalc}m`;
            daysWorked.textContent = workingDays;
            
            if (workingDays > 0) {
                const avgMs = totalMs / workingDays;
                const avgHours = Math.floor(avgMs / (1000 * 60 * 60));
                const avgMinutes = Math.floor((avgMs % (1000 * 60 * 60)) / (1000 * 60));
                averageDaily.textContent = `${avgHours}h ${avgMinutes}m`;
            } else {
                averageDaily.textContent = '0h 0m';
            }
            
            // Recalcular salario si hay un rol seleccionado
            calculateSalary();
        }

        // Funci√≥n para actualizar la informaci√≥n de la semana
        function updateWeekInfo() {
            const monday = getMondayOfWeek(new Date(weekStart.value));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            weekInfo.textContent = `Semana del ${formatDate(monday)} al ${formatDate(sunday)}`;
            
            daysContainer.innerHTML = '';
            
            setTimeout(() => {
                generateWeek(monday);
            }, 10);
        }

        // Funci√≥n para limpiar semana
        function clearWeek() {
            if (confirm('¬øEst√°s seguro de que quieres borrar todos los datos de esta semana?')) {
                try {
                    localStorage.removeItem(currentWeekKey);
                } catch(e) {
                    console.log('Limpieza simulada en Claude.ai');
                }
                generateWeek(getMondayOfWeek(new Date(weekStart.value)));
                updateWeeklySummary();
                lastSaved.textContent = '√öltimo guardado: Datos eliminados';
            }
        }

        // Funci√≥n para copiar al portapapeles
        async function copyToClipboard() {
            const monday = getMondayOfWeek(new Date(weekStart.value));
            let report = `üìÖ REGISTRO SEMANAL DE HORAS\n`;
            report += `Semana del ${formatDate(monday)} al ${formatDate(new Date(monday.getTime() + 6 * 24 * 60 * 60 * 1000))}\n\n`;
            
            for (let i = 0; i < 7; i++) {
                const startInput = document.getElementById(`start-${i}`);
                const endInput = document.getElementById(`end-${i}`);
                const totalDisplay = document.getElementById(`total-${i}`);
                
                const currentDate = new Date(monday);
                currentDate.setDate(monday.getDate() + i);
                
                report += `${daysOfWeek[i].toUpperCase()} - ${formatDate(currentDate)}\n`;
                report += `Inicio: ${startInput.value || 'No registrado'}\n`;
                report += `Fin: ${endInput.value || 'No registrado'}\n`;
                report += `Total: ${totalDisplay.textContent}\n\n`;
            }
            
            report += `üìä RESUMEN SEMANAL:\n`;
            report += `Total de horas: ${totalHours.textContent}\n`;
            report += `D√≠as trabajados: ${daysWorked.textContent}\n`;
            report += `Promedio diario: ${averageDaily.textContent}\n\n`;
            
            // Agregar informaci√≥n salarial si est√° disponible
            if (jobRole.value) {
                const roleName = jobRole.value === 'jefe' ? 'Jefe' : 'Pe√≥n';
                const rate = salaryRates[jobRole.value];
                report += `üí∞ C√ÅLCULO SALARIAL:\n`;
                report += `Puesto: ${roleName}\n`;
                report += `Tarifa: ‚Ç°${rate.toLocaleString()}/hora\n`;
                report += `Salario total: ${totalSalaryDisplay.textContent}\n\n`;
            }
            
            report += `Generado el ${new Date().toLocaleString('es-ES')}`;

            try {
                await navigator.clipboard.writeText(report);
                
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ ¬°Copiado!';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
                
            } catch (err) {
                console.error('Error al copiar: ', err);
                alert('No se pudo copiar al portapapeles');
            }
        }

        // Inicializaci√≥n
        function init() {
            const today = new Date();
            const monday = getMondayOfWeek(today);
            weekStart.value = monday.toISOString().split('T')[0];
            
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                autoSaveStatus.innerHTML = 'üü¢ Auto-guardado y reinicio autom√°tico activados';
            } catch(e) {
                autoSaveStatus.innerHTML = 'üü° Modo demostraci√≥n (funciona completamente en GitHub Pages)';
                autoSaveStatus.style.color = '#fbbf24';
            }
            
            if (checkForWeekReset()) {
                resetToNewWeek();
            } else {
                updateWeekInfo();
            }
            
            // Configurar intervalos
            autoSaveInterval = setInterval(autoSave, 30000);
            weekCheckInterval = setInterval(performWeeklyCheck, 60000);
            countdownInterval = setInterval(updateCountdown, 60000);
            
            window.addEventListener('beforeunload', autoSave);
            
            updateCountdown();
            updateLastSaved();
            
            console.log('üìÖ Sistema de registro semanal avanzado iniciado con reinicio autom√°tico los lunes a las 00:00');
        }

        // Event listeners
        weekStart.addEventListener('change', updateWeekInfo);
        copyBtn.addEventListener('click', copyToClipboard);
        clearBtn.addEventListener('click', clearWeek);

        // Cleanup al cerrar
        window.addEventListener('beforeunload', () => {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            if (weekCheckInterval) clearInterval(weekCheckInterval);
            if (countdownInterval) clearInterval(countdownInterval);
        });

        // Inicializar la aplicaci√≥n
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            setTimeout(init, 100);
        }
    </script>
</body>
</html>