<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro Multi-Empleados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            padding: 20px;
            color: #f1f5f9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        h1 {
            text-align: center;
            color: #f1f5f9;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 600;
        }

        /* Employee card styles */
        .employee-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin-bottom: 25px;
            border-radius: 15px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .employee-card.boss {
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
        }

        .employee-header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .employee-card.boss .employee-header {
            background: linear-gradient(135deg, #d97706, #fbbf24);
        }

        .employee-header:hover {
            background: linear-gradient(135deg, #2563eb, #60a5fa);
        }

        .employee-card.boss .employee-header:hover {
            background: linear-gradient(135deg, #f59e0b, #fcd34d);
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .employee-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .employee-details h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .employee-role {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .employee-summary {
            text-align: right;
            font-size: 0.9rem;
        }

        .hours-worked {
            font-size: 1.2rem;
            font-weight: bold;
            color: #60a5fa;
        }

        .salary-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #34d399;
        }

        .employee-content {
            padding: 25px;
            display: none;
        }

        .employee-content.expanded {
            display: block;
        }

        .week-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .week-selector label {
            color: #f1f5f9;
            margin-right: 10px;
            font-weight: 500;
        }

        .week-selector input {
            padding: 8px 12px;
            border: 2px solid #475569;
            border-radius: 6px;
            background: #0f172a;
            color: #f1f5f9;
            font-size: 1rem;
        }

        .week-info {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 1.1rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .day-card {
            background: #0f172a;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .day-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #cbd5e1;
            font-weight: 600;
        }

        .day-name {
            font-size: 1.1rem;
            color: #60a5fa;
        }

        .day-date {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .time-input {
            padding: 8px;
            border: 1px solid #475569;
            border-radius: 6px;
            background: #1e293b;
            color: #f1f5f9;
            font-size: 0.9rem;
        }

        .time-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .day-total {
            text-align: center;
            padding: 8px;
            background: #1e293b;
            border-radius: 6px;
            font-weight: bold;
            color: #60a5fa;
            font-size: 0.9rem;
        }

        .employee-salary-summary {
            background: #0f172a;
            border: 2px solid #a855f7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .employee-card.boss .employee-salary-summary {
            border-color: #fbbf24;
        }

        .salary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .salary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2rem;
            color: #34d399;
        }

        .salary-label {
            color: #cbd5e1;
        }

        .salary-value {
            color: #a855f7;
            font-weight: 600;
        }

        .employee-card.boss .salary-value {
            color: #fbbf24;
        }

        .total-salary {
            color: #34d399 !important;
            font-size: 1.3rem !important;
        }

        .status-bar {
            background: #0f172a;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .auto-save-status {
            color: #10b981;
            font-weight: 500;
        }

        .last-saved {
            color: #cbd5e1;
        }

        .reset-notification {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
            animation: slideDown 0.5s ease-out;
            display: none;
        }

        .reset-notification.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .countdown-info {
            background: #0f172a;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(124, 58, 237, 0.3);
            text-align: center;
            font-size: 0.9rem;
            color: #a855f7;
        }

        .global-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .action-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .action-btn.danger:hover {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .action-btn.success {
            background: linear-gradient(135deg, #059669, #10b981);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .action-btn.success:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }

            .days-grid {
                grid-template-columns: 1fr;
            }

            .time-inputs {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .employee-info {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .employee-summary {
                text-align: center;
            }

            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>👥 Sistema de Registro Multi-Empleados</h1>
        
        <div class="reset-notification" id="resetNotification">
            🔄 ¡Nueva semana iniciada automáticamente! Los datos de la semana anterior se mantienen guardados.
        </div>
        
        <div class="status-bar">
            <div class="auto-save-status" id="autoSaveStatus">
                🟢 Auto-guardado y reinicio automático activados
            </div>
            <div class="last-saved" id="lastSaved">
                Último guardado: Nunca
            </div>
        </div>
        
        <div class="countdown-info" id="countdownInfo">
            🕐 Próximo reinicio automático: Calculando...
        </div>
        
        <div class="week-selector">
            <label for="weekStart">Semana del:</label>
            <input type="date" id="weekStart">
        </div>
        
        <div class="week-info" id="weekInfo">
            Cargando información de la semana...
        </div>

        <div id="employeesContainer">
            <!-- Los empleados se generarán aquí dinámicamente -->
        </div>

        <div class="global-actions">
            <button class="action-btn success" onclick="generateWeeklyReport()">
                📊 Generar Reporte Completo
            </button>
            <button class="action-btn" onclick="copyAllData()">
                📋 Copiar Todos los Datos
            </button>
            <button class="action-btn danger" onclick="clearAllData()">
                🗑️ Limpiar Toda la Semana
            </button>
        </div>
    </div>

    <script>
        // Configuración
        const daysOfWeek = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
        const months = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];

        // Configuración de empleados
        const employees = [
            {
                id: 'boss',
                name: 'Jefe Principal',
                role: 'Supervisor General',
                hourlyRate: 4500,
                avatar: '👨‍💼',
                isBoss: true
            },
            {
                id: 'employee1',
                name: 'Empleado 1',
                role: 'Peón',
                hourlyRate: 2000,
                avatar: '👷‍♂️',
                isBoss: false
            },
            {
                id: 'employee2',
                name: 'Empleado 2',
                role: 'Peón',
                hourlyRate: 2000,
                avatar: '👷‍♀️',
                isBoss: false
            },
            {
                id: 'employee3',
                name: 'Empleado 3',
                role: 'Peón',
                hourlyRate: 2000,
                avatar: '👨‍🔧',
                isBoss: false
            },
            {
                id: 'employee4',
                name: 'Empleado 4',
                role: 'Peón',
                hourlyRate: 2000,
                avatar: '👩‍🔧',
                isBoss: false
            },
            {
                id: 'employee5',
                name: 'Empleado 5',
                role: 'Peón',
                hourlyRate: 2000,
                avatar: '👨‍🏭',
                isBoss: false
            }
        ];

        // Elementos del DOM
        const weekStart = document.getElementById('weekStart');
        const weekInfo = document.getElementById('weekInfo');
        const employeesContainer = document.getElementById('employeesContainer');
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        const lastSaved = document.getElementById('lastSaved');
        const resetNotification = document.getElementById('resetNotification');
        const countdownInfo = document.getElementById('countdownInfo');

        // Variables globales
        let currentWeekKey = '';
        let autoSaveInterval;
        let weekCheckInterval;
        let countdownInterval;

        // Función para obtener el lunes de la semana
        function getMondayOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // Función para formatear fecha
        function formatDate(date) {
            try {
                const day = date.getDate();
                const month = months[date.getMonth()];
                return `${day} de ${month}`;
            } catch(e) {
                return 'Fecha inválida';
            }
        }

        // Función para generar clave de semana
        function generateWeekKey(mondayDate) {
            return `week_${mondayDate.getFullYear()}_${mondayDate.getMonth()}_${mondayDate.getDate()}`;
        }

        // Función para calcular horas entre dos tiempos
        function calculateHoursBetween(start, end, date) {
            if (!start || !end) return { hours: 0, minutes: 0, totalMinutes: 0 };
            
            const startTime = new Date(`${date}T${start}`);
            let endTime = new Date(`${date}T${end}`);
            
            if (endTime <= startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }
            
            const diffMs = endTime - startTime;
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const totalMinutes = hours * 60 + minutes;
            
            return { hours, minutes, totalMinutes };
        }

        // Función para alternar empleado
        function toggleEmployee(employeeId) {
            const card = document.getElementById(`card-${employeeId}`);
            const content = document.getElementById(`content-${employeeId}`);
            
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                content.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
            }
        }

        // Función para actualizar el total de un día específico de un empleado
        function updateDayTotal(employeeId, dayIndex) {
            const monday = getMondayOfWeek(new Date(weekStart.value));
            const currentDate = new Date(monday);
            currentDate.setDate(monday.getDate() + dayIndex);
            
            const startInput = document.getElementById(`${employeeId}-start-${dayIndex}`);
            const endInput = document.getElementById(`${employeeId}-end-${dayIndex}`);
            const totalDisplay = document.getElementById(`${employeeId}-total-${dayIndex}`);
            
            if (!startInput || !endInput || !totalDisplay) return;
            
            const dateString = currentDate.toISOString().split('T')[0];
            const result = calculateHoursBetween(startInput.value, endInput.value, dateString);
            
            totalDisplay.textContent = `${result.hours}h ${result.minutes}m`;
            
            updateEmployeeSummary(employeeId);
            autoSave();
        }

        // Función para actualizar el resumen de un empleado
        function updateEmployeeSummary(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            let totalMinutes = 0;
            let workingDays = 0;
            
            for (let i = 0; i < 7; i++) {
                const startInput = document.getElementById(`${employeeId}-start-${i}`);
                const endInput = document.getElementById(`${employeeId}-end-${i}`);
                
                if (startInput && endInput && startInput.value && endInput.value) {
                    const monday = getMondayOfWeek(new Date(weekStart.value));
                    const currentDate = new Date(monday);
                    currentDate.setDate(monday.getDate() + i);
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    const result = calculateHoursBetween(startInput.value, endInput.value, dateString);
                    totalMinutes += result.totalMinutes;
                    
                    if (result.totalMinutes > 0) {
                        workingDays++;
                    }
                }
            }
            
            const totalHours = Math.floor(totalMinutes / 60);
            const remainingMinutes = totalMinutes % 60;
            const totalSalary = Math.round((totalMinutes / 60) * employee.hourlyRate);
            
            // Actualizar header del empleado
            const hoursDisplay = document.getElementById(`${employeeId}-hours`);
            const salaryDisplay = document.getElementById(`${employeeId}-salary`);
            
            if (hoursDisplay) hoursDisplay.textContent = `${totalHours}h ${remainingMinutes}m`;
            if (salaryDisplay) salaryDisplay.textContent = `₡${totalSalary.toLocaleString()}`;
            
            // Actualizar resumen detallado
            const summaryHours = document.getElementById(`${employeeId}-summary-hours`);
            const summaryDays = document.getElementById(`${employeeId}-summary-days`);
            const summaryRate = document.getElementById(`${employeeId}-summary-rate`);
            const summaryTotal = document.getElementById(`${employeeId}-summary-total`);
            
            if (summaryHours) summaryHours.textContent = `${totalHours}h ${remainingMinutes}m`;
            if (summaryDays) summaryDays.textContent = workingDays;
            if (summaryRate) summaryRate.textContent = `₡${employee.hourlyRate.toLocaleString()}`;
            if (summaryTotal) summaryTotal.textContent = `₡${totalSalary.toLocaleString()}`;
        }

        // Función para generar una tarjeta de empleado
        function generateEmployeeCard(employee) {
            const monday = getMondayOfWeek(new Date(weekStart.value));
            
            let daysHTML = '';
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(monday);
                currentDate.setDate(monday.getDate() + i);
                
                daysHTML += `
                    <div class="day-card">
                        <div class="day-header">
                            <span class="day-name">${daysOfWeek[i]}</span>
                            <span class="day-date">${formatDate(currentDate)}</span>
                        </div>
                        <div class="time-inputs">
                            <input type="time" 
                                   id="${employee.id}-start-${i}" 
                                   class="time-input" 
                                   placeholder="Inicio"
                                   onchange="updateDayTotal('${employee.id}', ${i})">
                            <input type="time" 
                                   id="${employee.id}-end-${i}" 
                                   class="time-input" 
                                   placeholder="Fin"
                                   onchange="updateDayTotal('${employee.id}', ${i})">
                            <div class="day-total" id="${employee.id}-total-${i}">0h 0m</div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="employee-card ${employee.isBoss ? 'boss' : ''}" id="card-${employee.id}">
                    <div class="employee-header" onclick="toggleEmployee('${employee.id}')">
                        <div class="employee-info">
                            <div class="employee-avatar">${employee.avatar}</div>
                            <div class="employee-details">
                                <h3>${employee.name}</h3>
                                <div class="employee-role">${employee.role}</div>
                            </div>
                        </div>
                        <div class="employee-summary">
                            <div class="hours-worked" id="${employee.id}-hours">0h 0m</div>
                            <div class="salary-amount" id="${employee.id}-salary">₡0</div>
                        </div>
                    </div>
                    <div class="employee-content" id="content-${employee.id}">
                        <div class="days-grid">
                            ${daysHTML}
                        </div>
                        <div class="employee-salary-summary">
                            <div class="salary-row">
                                <span class="salary-label">Horas Trabajadas:</span>
                                <span class="salary-value" id="${employee.id}-summary-hours">0h 0m</span>
                            </div>
                            <div class="salary-row">
                                <span class="salary-label">Días Trabajados:</span>
                                <span class="salary-value" id="${employee.id}-summary-days">0</span>
                            </div>
                            <div class="salary-row">
                                <span class="salary-label">Tarifa por Hora:</span>
                                <span class="salary-value" id="${employee.id}-summary-rate">₡${employee.hourlyRate.toLocaleString()}</span>
                            </div>
                            <div class="salary-row">
                                <span class="salary-label">Salario Total:</span>
                                <span class="salary-value total-salary" id="${employee.id}-summary-total">₡0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Función para generar todos los empleados
        function generateAllEmployees() {
            employeesContainer.innerHTML = '';
            currentWeekKey = generateWeekKey(getMondayOfWeek(new Date(weekStart.value)));
            
            employees.forEach(employee => {
                const cardHTML = generateEmployeeCard(employee);
                employeesContainer.insertAdjacentHTML('beforeend', cardHTML);
            });
            
            // Cargar datos guardados después de un breve delay
            setTimeout(() => {
                loadAllData();
            }, 100);
        }

        // Función para auto-guardar
        function autoSave() {
            try {
                const weekData = {};
                
                employees.forEach(employee => {
                    const employeeData = {};
                    for (let i = 0; i < 7; i++) {
                        const startInput = document.getElementById(`${employee.id}-start-${i}`);
                        const endInput = document.getElementById(`${employee.id}-end-${i}`);
                        
                        if (startInput && endInput) {
                            employeeData[`day_${i}`] = {
                                start: startInput.value,
                                end: endInput.value,
                                timestamp: new Date().toISOString()
                            };
                        }
                    }
                    weekData[employee.id] = employeeData;
                });
                
                localStorage.setItem(currentWeekKey, JSON.stringify(weekData));
                updateLastSaved();
            } catch(e) {
                console.log('Auto-guardado simulado');
                updateLastSaved();
            }
        }

        // Función para cargar todos los datos
        function loadAllData() {
            try {
                const weekData = JSON.parse(localStorage.getItem(currentWeekKey) || '{}');
                
                employees.forEach(employee => {
                    const employeeData = weekData[employee.id] || {};
                    
                    for (let i = 0; i < 7; i++) {
                        const dayData = employeeData[`day_${i}`];
                        const startInput = document.getElementById(`${employee.id}-start-${i}`);
                        const endInput = document.getElementById(`${employee.id}-end-${i}`);
                        
                        if (startInput && endInput && dayData) {
                            startInput.value = dayData.start || '';
                            endInput.value = dayData.end || '';
                            updateDayTotal(employee.id, i);
                        }
                    }
                    
                    updateEmployeeSummary(employee.id);
                });
            } catch(e) {
                console.log('No hay datos guardados para cargar');
            }
        }

        // Función para actualizar último guardado
        function updateLastSaved() {
            const now = new Date();
            lastSaved.textContent = `Último guardado: ${now.toLocaleTimeString('es-ES')}`;
        }

        // Función para actualizar la información de la semana
        function updateWeekInfo() {
            const monday = getMondayOfWeek(new Date(weekStart.value));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            weekInfo.textContent = `Semana del ${formatDate(monday)} al ${formatDate(sunday)}`;
            
            generateAllEmployees();
        }

        // Función para generar reporte semanal completo
        function generateWeeklyReport() {
            const monday = getMondayOfWeek(new Date(weekStart.value));
            let report = `📋 REPORTE SEMANAL COMPLETO\n`;
            report += `Semana del ${formatDate(monday)} al ${formatDate(new Date(monday.getTime() + 6 * 24 * 60 * 60 * 1000))}\n\n`;
            
            let totalPayroll = 0;
            
            employees.forEach(employee => {
                let employeeTotalMinutes = 0;
                let employeeWorkingDays = 0;
                
                report += `${employee.avatar} ${employee.name.toUpperCase()} - ${employee.role}\n`;
                report += `Tarifa: ₡${employee.hourlyRate.toLocaleString()}/hora\n`;
                report += `${'─'.repeat(40)}\n`;
                
                for (let i = 0; i < 7; i++) {
                    const startInput = document.getElementById(`${employee.id}-start-${i}`);
                    const endInput = document.getElementById(`${employee.id}-end-${i}`);
                    
                    const currentDate = new Date(monday);
                    currentDate.setDate(monday.getDate() + i);
                    
                    if (startInput && endInput) {
                        const start = startInput.value || 'No registrado';
                        const end = endInput.value || 'No registrado';
                        
                        if (start !== 'No registrado' && end !== 'No registrado') {
                            const dateString = currentDate.toISOString().split('T')[0];
                            const result = calculateHoursBetween(start, end, dateString);
                            employeeTotalMinutes += result.totalMinutes;
                            if (result.totalMinutes > 0) employeeWorkingDays++;
                            
                            report += `${daysOfWeek[i]} ${formatDate(currentDate)}: ${start} - ${end} (${result.hours}h ${result.minutes}m)\n`;
                        } else {
                            report += `${daysOfWeek[i]} ${formatDate(currentDate)}: No trabajó\n`;
                        }
                    }
                }
                
                const totalHours = Math.floor(employeeTotalMinutes / 60);
                const totalMinutes = employeeTotalMinutes % 60;
                const salary = Math.round((employeeTotalMinutes / 60) * employee.hourlyRate);
                totalPayroll += salary;
                
                report += `\nResumen:\n`;
                report += `• Total horas: ${totalHours}h ${totalMinutes}m\n`;
                report += `• Días trabajados: ${employeeWorkingDays}\n`;
                report += `• Salario: ₡${salary.toLocaleString()}\n\n`;
            });
            
            report += `💰 RESUMEN GENERAL:\n`;
            report += `Total nómina semanal: ₡${totalPayroll.toLocaleString()}\n`;
            report += `Generado el: ${new Date().toLocaleString('es-ES')}\n`;
            
            // Mostrar en una ventana nueva o copiar al portapapeles
            if (navigator.clipboard) {
                navigator.clipboard.writeText(report).then(() => {
                    alert('📋 Reporte completo copiado al portapapeles');
                }).catch(() => {
                    showReportModal(report);
                });
            } else {
                showReportModal(report);
            }
        }
        
        // Función para mostrar reporte en modal
        function showReportModal(report) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: #1e293b; border-radius: 10px; padding: 30px; max-width: 800px; max-height: 80%; overflow-y: auto; color: #f1f5f9;">
                    <h2 style="margin-bottom: 20px; color: #60a5fa;">📋 Reporte Semanal Completo</h2>
                    <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; line-height: 1.4;">${report}</pre>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Función para copiar todos los datos
        function copyAllData() {
            generateWeeklyReport();
        }

        // Función para limpiar todos los datos
        function clearAllData() {
            if (confirm('¿Estás seguro de que quieres borrar TODOS los datos de esta semana para TODOS los empleados?')) {
                try {
                    localStorage.removeItem(currentWeekKey);
                } catch(e) {
                    console.log('Limpieza simulada');
                }
                
                // Limpiar todos los inputs
                employees.forEach(employee => {
                    for (let i = 0; i < 7; i++) {
                        const startInput = document.getElementById(`${employee.id}-start-${i}`);
                        const endInput = document.getElementById(`${employee.id}-end-${i}`);
                        
                        if (startInput) startInput.value = '';
                        if (endInput) endInput.value = '';
                        
                        updateDayTotal(employee.id, i);
                    }
                    updateEmployeeSummary(employee.id);
                });
                
                updateLastSaved();
                alert('✅ Todos los datos han sido eliminados');
            }
        }

        // **FUNCIONES DE REINICIO AUTOMÁTICO - MODIFICADAS PARA DOMINGOS 00:00**
        function getNextSundayMidnight() {
            const now = new Date();
            const nextSunday = new Date(now);
            
            // Calcular días hasta el próximo domingo
            let daysUntilSunday;
            if (now.getDay() === 0) {
                // Si hoy es domingo, el próximo es en 7 días
                daysUntilSunday = 7;
            } else {
                // Días hasta el próximo domingo
                daysUntilSunday = 7 - now.getDay();
            }
            
            nextSunday.setDate(now.getDate() + daysUntilSunday);
            nextSunday.setHours(0, 0, 0, 0);
            
            return nextSunday;
        }

        function updateCountdown() {
            const now = new Date();
            const nextReset = getNextSundayMidnight();
            const diff = nextReset - now;
            
            if (diff <= 0) {
                countdownInfo.textContent = '🔄 Reiniciando semana...';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            let countdownText = '🕐 Próximo reinicio automático: ';
            
            if (days > 0) {
                countdownText += `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                countdownText += `${hours}h ${minutes}m`;
            } else {
                countdownText += `${minutes}m`;
            }
            
            countdownText += ` (domingo 00:00)`;
            countdownInfo.textContent = countdownText;
        }

        function checkForWeekReset() {
            try {
                const lastWeekCheck = localStorage.getItem('lastWeekCheck');
                const now = new Date();
                const currentMondayKey = generateWeekKey(getMondayOfWeek(now));
                
                if (!lastWeekCheck) {
                    localStorage.setItem('lastWeekCheck', currentMondayKey);
                    return false;
                }
                
                if (lastWeekCheck !== currentMondayKey) {
                    localStorage.setItem('lastWeekCheck', currentMondayKey);
                    return true;
                }
                
                return false;
            } catch(e) {
                console.log('Verificación de reinicio en modo demostración');
                return false;
            }
        }

        function showResetNotification() {
            resetNotification.classList.add('show');
            
            setTimeout(() => {
                resetNotification.classList.remove('show');
            }, 5000);
        }

        function resetToNewWeek() {
            const today = new Date();
            const monday = getMondayOfWeek(today);
            weekStart.value = monday.toISOString().split('T')[0];
            updateWeekInfo();
            showResetNotification();
            
            console.log('Semana reiniciada automáticamente:', formatDate(monday));
        }

        function performWeeklyCheck() {
            const now = new Date();
            
            // Verificar si es domingo a las 00:00 (medianoche)
            if (now.getDay() === 0 && now.getHours() === 0 && now.getMinutes() === 0) {
                console.log('🔄 Iniciando reinicio automático del domingo a medianoche...');
                resetToNewWeek();
            }
            
            // Verificación adicional para cambio de semana
            if (checkForWeekReset()) {
                console.log('🔄 Detectado cambio de semana, reiniciando...');
                resetToNewWeek();
            }
        }

        // Inicialización
        function init() {
            const today = new Date();
            const monday = getMondayOfWeek(today);
            weekStart.value = monday.toISOString().split('T')[0];
            
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                autoSaveStatus.innerHTML = '🟢 Auto-guardado y reinicio automático activados (domingos 00:00)';
            } catch(e) {
                autoSaveStatus.innerHTML = '🟡 Modo demostración (funciona completamente en GitHub Pages)';
                autoSaveStatus.style.color = '#fbbf24';
            }
            
            if (checkForWeekReset()) {
                resetToNewWeek();
            } else {
                updateWeekInfo();
            }
            
            // Configurar intervalos
            autoSaveInterval = setInterval(autoSave, 30000);
            weekCheckInterval = setInterval(performWeeklyCheck, 60000);
            countdownInterval = setInterval(updateCountdown, 60000);
            
            window.addEventListener('beforeunload', autoSave);
            
            updateCountdown();
            updateLastSaved();
            
            console.log('👥 Sistema multi-empleados iniciado con reinicio automático los domingos a las 00:00');
        }

        // Event listeners
        weekStart.addEventListener('change', updateWeekInfo);

        // Cleanup al cerrar
        window.addEventListener('beforeunload', () => {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            if (weekCheckInterval) clearInterval(weekCheckInterval);
            if (countdownInterval) clearInterval(countdownInterval);
        });

        // Inicializar la aplicación
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            setTimeout(init, 100);
        }
    </script>
</body>
</html>